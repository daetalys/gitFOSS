# Read more about this feature here: https://docs.gitlab.com/ee/user/application_security/container_scanning/

container_scanning:
  stage: test
  image: registry.gitlab.com/gitlab-org/security-products/analyzers/klar:latest
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    # override this variable in your .gitlab-ci.yml file and set to `fetch` if you want to provide a clair-whitelist.yaml file
    GIT_STRATEGY: none
  allow_failure: true
  services:
    - name: arminc/clair-db:latest
      alias: clair-vulnerabilities-db
  script:
    - echo "Starting Container Scan"
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  dependencies: []
  only:
    refs:
      - branches
    variables:
      - $GITLAB_FEATURES =~ /\bcontainer_scanning\b/
  except:
    variables:
      - $CONTAINER_SCANNING_DISABLED
